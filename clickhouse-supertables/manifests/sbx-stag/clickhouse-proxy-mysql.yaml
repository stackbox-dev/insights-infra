apiVersion: v1
kind: ConfigMap
metadata:
  name: proxysql-config
  namespace: kafka
data:
  proxysql.cnf: |
    # This ProxySQL configuration is tailored for routing traffic to a ClickHouse
    # backend that is exposing its MySQL-compatible network protocol.

    # Basic ProxySQL Configuration for ClickHouse Rewrite
    admin_variables=
    {
        admin_credentials="admin:password" # Admin credentials
        mysql_ifaces="0.0.0.0:6032"        # ProxySQL admin interface
    }

    mysql_variables=
    {
        threads=2
        max_connections=500
        default_charset="utf8"              # Changed from utf8mb4 to match default collation
        interfaces="0.0.0.0:6033"           # Port for client connections
        stacksize="2048000"                 # Stack size setting
        
        # Only include basic settings that are supported
        connect_timeout_server=3000
        connection_delay_multiplex_ms=0
        monitor_enabled=0                   # Disable monitoring
        monitor_password=""                 # Empty password
        eventslog_filename=""               # Keep logs to stdout
        eventslog_format=1                  # CSV format
        eventslog_default_log=1             # Log all queries
        
        # Connection handling
        have_ssl=true
        have_compress=false
        multiplexing=false
        sessions_sort=false
        commands_stats=false
    }

    # Define the backend ClickHouse server
    mysql_servers:
    (
      {
        address="sbx-stag-clickhouse-stackbox.h.aivencloud.com"      # ClickHouse IP/hostname
        port=22156                                              # ClickHouse MySQL protocol port
        hostgroup_id=0
        max_connections=200
        weight=1000
        compression=0
        use_ssl=1
        ssl_cipher=""
        ssl_verify_server_cert=0
      }
    )

    # Define user credentials
    mysql_users:
    (
      {
        username="readonly"
        password="${CLICKHOUSE_PASSWORD}"   # Will be replaced with environment variable
        database="sbx_uat"
        active=1
        default_hostgroup=0
        max_connections=200
      }
    )

    # Single rule for all SET commands
    mysql_query_rules:
    (
      {
        rule_id=1
        active=1
        match_pattern="(?i)^SET\\s+.*" # Match any query starting with SET
        replace_pattern="SELECT 1"      # Replace with SELECT 1
        apply=1
      }
    )
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: proxysql-startup-script
  namespace: kafka
data:
  entrypoint.sh: |
    #!/bin/sh
    set -e
    
    # Create temporary config file with password substituted
    # Escape special characters in password to avoid sed issues
    ESCAPED_PASSWORD=$(echo "$CLICKHOUSE_PASSWORD" | sed 's/[\/&]/\\&/g')
    sed "s/\${CLICKHOUSE_PASSWORD}/$ESCAPED_PASSWORD/g" /etc/proxysql/proxysql.cnf > /etc/proxysql.cnf
    
    # Start ProxySQL with the generated config
    exec /usr/bin/proxysql -f -c /etc/proxysql.cnf --idle-threads
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: proxysql
  namespace: kafka
  labels:
    app: proxysql
spec:
  replicas: 1
  selector:
    matchLabels:
      app: proxysql
  template:
    metadata:
      labels:
        app: proxysql
    spec:
      containers:
        - name: proxysql
          image: proxysql/proxysql:2.6.2 # Use a recent stable version
          command: ["/bin/sh"]
          args:
            - "/scripts/entrypoint.sh"
          resources:
            requests:
              memory: "20Mi"
              cpu: "20m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          env: 
            - name: CLICKHOUSE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: clickhouse-readonly
                  key: password
          ports:
            - name: mysql
              containerPort: 6033 # For Frappe Insights client connections
            - name: admin
              containerPort: 6032 # For ProxySQL admin interface
          volumeMounts:
            - name: proxysql-config-volume
              mountPath: /etc/proxysql/proxysql.cnf
              subPath: proxysql.cnf
            - name: startup-script-volume
              mountPath: /scripts
      volumes:
        - name: proxysql-config-volume
          configMap:
            name: proxysql-config
        - name: startup-script-volume
          configMap:
            name: proxysql-startup-script
            defaultMode: 0755  # Make the script executable
---
apiVersion: v1
kind: Service
metadata:
  name: proxysql-service
  namespace: kafka
  labels:
    app: proxysql
  annotations:
    networking.gke.io/load-balancer-type: "Internal"
spec:
  type: LoadBalancer
  ports:
    - name: mysql
      port: 6033 # Port the service will listen on
      targetPort: 6033 # Port on the ProxySQL pods
      protocol: TCP
    - name: admin
      port: 6032 # Port for ProxySQL admin interface
      targetPort: 6032 # Port on the ProxySQL pods
      protocol: TCP
  selector:
    app: proxysql
